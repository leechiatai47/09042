<!-- ... (HTML 的 head 和 body 部分保持不變) ... -->

<script type="module">
  // ★★★ API 的網址現在是一個簡單的相對路徑 ★★★
  const API_ENDPOINT = '/.netlify/functions/generate';

  // --- 獲取頁面元素 ---
  const generateBtn = document.getElementById('generate-ai-response-btn');
  const fileInput = document.getElementById('document-file');
  const resultContainer = document.getElementById('ai-result-container');
  const resultCard = document.getElementById('ai-result-card');
  const aiSpinner = document.getElementById('ai-spinner');

  // --- 事件監聽 ---
  generateBtn.addEventListener('click', async () => {
    // 1. 顯示處理中狀態
    generateBtn.disabled = true;
    aiSpinner.style.display = 'inline-block';
    resultContainer.style.display = 'block';
    resultCard.classList.remove('alert-danger');
    resultCard.classList.add('alert-secondary');
    resultCard.textContent = '正在讀取資料並傳送給 AI...';

    // 2. 獲取角色資料
    const persona = {
      gender: document.getElementById('gender').value,
      age: document.getElementById('age').value,
      job: document.getElementById('job').value,
      other: document.getElementById('other').value || '無',
    };

    // 3. 獲取指令 Prompt
    const promptText = document.getElementById('prompt-text').value;
    
    // 4. 讀取上傳的檔案內容
    let documentContent = '';
    if (fileInput.files.length > 0) {
      try {
        documentContent = await fileInput.files[0].text();
        resultCard.textContent = '文件讀取成功，正在等待 AI 回應...';
      } catch (e) {
        resultCard.textContent = '錯誤：無法讀取檔案內容。';
        generateBtn.disabled = false;
        aiSpinner.style.display = 'none';
        return;
      }
    } else {
      resultCard.textContent = '警告：未上傳參考文件。正在等待 AI 回應...';
    }

    // 5. 組合要發送到後端的資料
    const payload = {
      persona,
      promptTemplate: promptText,
      documentContent,
    };

    // 6. 呼叫後端函式 (現在變得非常乾淨！)
    try {
      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.error || `伺服器錯誤: ${response.status}`);
      }
      
      resultCard.textContent = result.data;

    } catch (error) {
      console.error('Fetch error:', error);
      resultCard.textContent = `發生錯誤：\n${error.message}`;
      resultCard.classList.add('alert-danger');
    } finally {
      // 7. 無論成功或失敗，都重設按鈕狀態
      generateBtn.disabled = false;
      aiSpinner.style.display = 'none';
    }
  });
</script>